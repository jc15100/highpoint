{% extends 'base.html' %}

{% block content %}
<head>
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
</head>

<body>
    <body>
        <section class="section" id="app">
            <div class="container">
                <h1 class="title mb-6">Upload your video:</h1>
                
                <div class="file">
                    <label class="file-label">
                        <input type="file" ref="file" class="file-input" @change="selectFile" multiple>
                        
                        <span class="file-cta">
                            <span class="file-label">Choose a file...</span>
                        </span>
                    </label>
                </div>
                
                <button class="button is-primary mt-2" v-if="videos.length" @click="upload">Upload</button>
                
                <div class="notification mt-6" v-if="videos.length">
                    <p v-for="video in videos">
                        [[ video.name ]] [[ video.status ]]
                    </p>
                </div>
            </div>
            
            <div v-for="video in videos">
                <video
                id="result-{{video.name}}"
                class="video-js"
                controls
                preload="auto"
                width="640"
                height="264">
                    <source :src="result" type="video/mp4" />
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a
                        web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                    </p>
                </video>
            </div>
    </section>
    
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    
    <script>
        const { createApp } = Vue
        
        createApp({
            data() {
                return {
                    videos: [],
                    result: '',
                }
            },
            delimiters: ['[[', ']]'],
            methods: {
                selectFile() {
                    Array.from(this.$refs.file.files).forEach(file => {
                        this.upload(file)
                        
                        this.videos.push({
                            'name': file.name,
                            'status': 'is uploading'
                        })
                    })
                },
                upload(file) {
                    this.progress = 0
                    
                    this.performUpload(file)
                    .then(response => {
                        const data = response.data
                        if (data['success']) {
                            this.videos.forEach(video => {
                                if (video.name === file.name) {
                                    video['status'] = 'is uploaded'
                                }
                            })
                            
                            // set video path as result 
                            this.result = data.segments[0]
                            console.log("output segment path:" + data.segments[0])
                        }
                    })
                    .catch(error => {
                        console.log("Error " + error)
                        this.videos.forEach(video => {
                            if (video.name === file.name) {
                                video['status'] = 'failed'
                            }
                        })
                    })
                },
                performUpload(file) {
                    let formData = new FormData()
                    formData.append('location', file)
                    
                    return axios
                    .post('/upload/', formData, {
                        headers: {
                            "Content-Type": "multipart/form-data",
                            "X-CSRFToken": "{{ csrf_token }}"
                        }
                    })
                }
            }
        }).mount('#app')
    </script>
</body>
</body>
{% endblock %}